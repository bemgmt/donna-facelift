name: CI Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run TypeScript check
      run: npx tsc --noEmit
    
    - name: Run ESLint (strict)
      run: npm run lint -- --max-warnings 0
    
    - name: Run security audit
      run: npm audit --audit-level=high
    
    - name: Run tests
      run: npm run test:ci

    - name: Run WS2 contract test
      run: npm run test:ws2

    - name: Build application
      run: npm run build
    
    - name: Start Next server for integration tests
      run: |
        npm run start &
        sleep 10
        
    - name: Health check API (resilient)
      run: npm run health-check:resilient

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Run Playwright e2e smoke
      run: npx playwright test --grep @smoke
    
    - name: Run fanout smoke test
      run: npm run test:fanout:smoke

    # Start secured WS proxy for WS2 auth smoke
    - name: Start WebSocket proxy (WS2 auth smoke)
      working-directory: ./websocket-server
      env:
        ENABLE_WS_PROXY: 'true'
        AUTH_TIMEOUT_MS: '1000'
        JWT_SECRET: 'testsecret'
      run: |
        node server.js &
        sleep 2

    - name: WS2 WebSocket auth smoke
      env:
        NEXT_PUBLIC_WEBSOCKET_URL: 'ws://localhost:3001/realtime'
        JWT_SECRET: 'testsecret'
        AUTH_TIMEOUT_MS: '1000'
      run: npm run test:ws2-auth

    - name: Stop WebSocket proxy
      run: pkill -f "websocket-server/server.js" || true

    - name: Security smoke (CORS + unauth path)
      run: npm run -s test:security:smoke

    - name: Fanout smoke (server-to-server)
      run: npm run -s test:fanout:smoke
    
    - name: Security negative path tests (WS1)
      run: |
        echo "Testing unauthorized token issuance..."
        # Test 1: No auth token - expect 401
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3000/api/realtime/token)
        if [ "$response" != "401" ]; then
          echo "FAIL: Expected 401 for unauthenticated request, got $response"
          exit 1
        fi
        echo "✓ Unauthorized request correctly rejected with 401"
        
        # Test 2: Bad origin - expect 403
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "Origin: https://malicious.com" http://localhost:3000/api/realtime/token)
        if [ "$response" != "403" ]; then
          echo "FAIL: Expected 403 for bad origin, got $response"
          exit 1
        fi
        echo "✓ Bad origin correctly rejected with 403"
        
        # Test 3: Health endpoint with bad origin - expect 403
        response=$(curl -s -o /dev/null -w "%{http_code}" -H "Origin: https://evil.com" http://localhost:3000/api/health)
        if [ "$response" != "403" ]; then
          echo "FAIL: Expected 403 for health with bad origin, got $response"
          exit 1
        fi
        echo "✓ Health endpoint correctly enforces CORS"
        
        echo "All security negative path tests passed!"
      
    - name: Stop Next server
      run: pkill -f "next start" || true
    
    # WebSocket server tests
    - name: Install WebSocket server dependencies
      working-directory: ./websocket-server
      run: npm ci
    
    - name: Test WebSocket server
      working-directory: ./websocket-server
      run: npm test

    - name: WebSocket auth smoke
      working-directory: ./websocket-server
      run: npm run -s smoke:auth
    
    # PHP Tests (for backend validation)
    - name: Run PHP tests
      run: |
        # Test core PHP functionality with Docker
        docker run --rm -v ${{ github.workspace }}:/app -w /app php:8.2-cli php tests/php/test_error_responses.php
        docker run --rm -v ${{ github.workspace }}:/app -w /app php:8.2-cli php tests/php/test_error_responses_comprehensive.php
        docker run --rm -v ${{ github.workspace }}:/app -w /app php:8.2-cli php tests/php/test_response_cache_integration.php
        docker run --rm -v ${{ github.workspace }}:/app -w /app php:8.2-cli php tests/php/test_caching.php
        docker run --rm -v ${{ github.workspace }}:/app -w /app php:8.2-cli php api/test-rate-limit.php
    
    - name: Validate PHP response schemas
      run: npm run test:php-schemas

  security-and-analysis:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run security audit
      run: npm audit --audit-level=moderate
    
    - name: Static Analysis - Bundle analyzer
      run: |
        npm run build
        npx @next/bundle-analyzer || echo "Bundle analysis completed"
    
    - name: Static Analysis - Unused exports
      run: npx unimported || echo "Unused exports check completed"
    
    - name: Static Analysis - Dependency check
      run: npx depcheck || echo "Dependency check completed"
    
    - name: Performance check - Build size
      run: |
        npm run build
        du -sh .next/static || echo "Build size check completed"

